# Fortune Photo Upload Contract

**Last Updated**: 2025-01-27  
**Status**: Production-ready

This document defines the **single source of truth** for the Fortune photo upload protocol used by Web and iOS clients.

## Overview

The upload flow consists of three steps:
1. **Get Upload Ticket**: Call `issue-fortune-upload-ticket` to get a signed upload URL and upload instructions
2. **Upload File**: Upload the image file to the signed URL using the specified method
3. **Finalize**: Call `finalize-fortune-photo` to confirm upload and get a signed GET URL

## Step 1: Get Upload Ticket

**Endpoint**: `POST /functions/v1/issue-fortune-upload-ticket`

**Request Headers**:
```
Authorization: Bearer <access_token>
Content-Type: application/json
```

**Request Body**:
```json
{
  "fortune_id": "<uuid>",
  "mime": "image/jpeg"  // or "image/png", "image/webp", "image/gif"
}
```

**Response** (200 OK):
```json
{
  "bucket": "photos",
  "bucketRelativePath": "<userId>/<fortuneId>-<random>.ext",
  "dbPath": "<userId>/<fortuneId>-<random>.ext",  // Same as bucketRelativePath
  "url": "https://<storage-url>/<path>?<signed-params>",
  "uploadMethod": "POST_MULTIPART",
  "headers": {
    "x-upsert": "true"
  },
  "formFieldName": "file",
  "buildTag": "2025-01-27T00:00:00Z-issue-fortune-upload-ticket"
}
```

**Important Notes**:
- `bucketRelativePath` is **bucket-relative** (NO `photos/` prefix)
- `dbPath` is identical to `bucketRelativePath` (canonical format)
- The signed URL in `url` is valid for 2 minutes

## Step 2: Upload File

**Method**: `POST` (multipart/form-data)

**URL**: Use the `url` from Step 1

**Headers**:
```
Content-Type: multipart/form-data; boundary=<auto-generated>
x-upsert: true
```

**Body**:
- Content-Type: `multipart/form-data`
- Form field name: `file` (must match `formFieldName` from Step 1)
- Form field value: Image file (binary data)

**Example (JavaScript/Web)**:
```javascript
const formData = new FormData();
formData.append('file', imageFile);

const response = await fetch(uploadUrl, {
  method: 'POST',
  headers: {
    'x-upsert': 'true'
    // DO NOT set Content-Type header - browser will set it with boundary
  },
  body: formData
});
```

**Example (iOS/Swift)**:
```swift
// Create multipart form data
var request = URLRequest(url: uploadURL)
request.httpMethod = "POST"
request.setValue("true", forHTTPHeaderField: "x-upsert")

let boundary = UUID().uuidString
request.setValue("multipart/form-data; boundary=\(boundary)", forHTTPHeaderField: "Content-Type")

var body = Data()
body.append("--\(boundary)\r\n".data(using: .utf8)!)
body.append("Content-Disposition: form-data; name=\"file\"; filename=\"image.jpg\"\r\n".data(using: .utf8)!)
body.append("Content-Type: image/jpeg\r\n\r\n".data(using: .utf8)!)
body.append(imageData)
body.append("\r\n--\(boundary)--\r\n".data(using: .utf8)!)

request.httpBody = body

let (data, response) = try await URLSession.shared.data(for: request)
```

**Critical Requirements**:
- ❌ **DO NOT** use `PUT` method - it will NOT persist the file
- ✅ **MUST** use `POST` with `multipart/form-data`
- ✅ **MUST** use form field name `file` (from `formFieldName` in response)
- ✅ **MUST** include header `x-upsert: true`
- ✅ **DO NOT** include `Content-Type` header with boundary (browser/client library will add it)

**Response** (200 OK):
- Empty body or success message
- Check `response.ok` or HTTP status 200-299

## Step 3: Finalize Upload

**Endpoint**: `POST /functions/v1/finalize-fortune-photo`

**Request Headers**:
```
Authorization: Bearer <access_token>
Content-Type: application/json
```

**Request Body**:
```json
{
  "fortune_id": "<uuid>",
  "bucket": "photos",
  "path": "<bucketRelativePath>",  // From Step 1, NO bucket prefix
  "width": 1920,  // Optional, but recommended
  "height": 1080,  // Optional, but recommended
  "size_bytes": 524288,  // Optional, but recommended
  "mime": "image/jpeg"
}
```

**Response** (200 OK):
```json
{
  "signedUrl": "https://<storage-url>/<path>?<signed-params>",
  "replaced": false,  // true if replacing existing photo
  "media": {
    "fortune_id": "<uuid>",
    "bucket": "photos",
    "path": "<bucketRelativePath>",
    "updated_at": "2025-01-27T12:34:56.789Z"  // Use for cache-busting
  },
  "buildTag": "2025-01-27T00:00:00Z-finalize-fortune-photo"
}
```

**Important Notes**:
- `path` must be **bucket-relative** (no `photos/` prefix)
- `updated_at` should be used as cache-busting version in UI
- `replaced: true` means an existing photo was replaced

## Error Responses

All endpoints return errors in this format:
```json
{
  "error": "Error message"
}
```

Common HTTP status codes:
- `400`: Invalid request (missing/invalid parameters)
- `401`: Authentication required/invalid
- `403`: Access denied (not Pro/Lifetime or trial expired)
- `404`: Fortune not found
- `500`: Internal server error

## Path Format

All paths stored in DB and used with Storage API are **bucket-relative**:
- ✅ Correct: `a1b2c3d4-.../e5f6g7h8-...-abc12345.jpg`
- ❌ Wrong: `photos/a1b2c3d4-.../e5f6g7h8-...-abc12345.jpg`

Format: `<userId>/<fortuneId>-<random8chars>.<ext>`

## Access Control

Photo uploads require:
- User owns the fortune
- User has **active subscription** OR is in **trial period**

Subscription access logic:
- **Lifetime**: `is_lifetime = true AND status = 'active'`
- **Recurring**: `status IN ('active', 'trialing')`
- **Trial**: `trial_ends_at > NOW()`
- **All other statuses** (`past_due`, `canceled`, etc.): ❌ No access

## Deployment Drift Detection

Both edge functions include a `buildTag` in:
- Function logs: `{ BUILD_TAG: '2025-01-27T00:00:00Z-...' }`
- Response payload: `{ "buildTag": "2025-01-27T00:00:00Z-..." }`

**To verify deployed version matches repo**:
1. Check Supabase Edge Function logs for `BUILD_TAG` value
2. Compare with `BUILD_TAG` constant in repo source code
3. If mismatch, function needs redeployment

## Client Implementation Checklist

### Web (JavaScript/TypeScript)
- [x] Uses `FormData` with field name `file`
- [x] Uses `POST` method (not PUT)
- [x] Includes `x-upsert: true` header
- [x] Does NOT manually set `Content-Type` header (browser handles boundary)

### iOS (Swift)
- [ ] Uses `URLRequest` with `POST` method
- [ ] Creates multipart form data with field name `file`
- [ ] Includes `x-upsert: true` header
- [ ] Sets `Content-Type` with boundary: `multipart/form-data; boundary=<uuid>`

## Troubleshooting

### Upload succeeds but file not found in bucket
- **Cause**: Using `PUT` instead of `POST multipart`
- **Fix**: Ensure client uses `POST` with `multipart/form-data` and field name `file`

### `UPLOAD_NOT_PERSISTED` error in finalize
- **Cause**: File was uploaded but not found when listing bucket
- **Fix**: Ensure upload used correct method and form field name

### Cache-busting not working
- **Cause**: UI not using `updated_at` from finalize response
- **Fix**: Use `media.updated_at` as version parameter in signed URL cache key
